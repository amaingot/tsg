service:
  name: tsg-api
  app: tsg

plugins:
  - serverless-dotenv-plugin
  - serverless-webpack
  - serverless-offline

provider:
  name: aws
  runtime: nodejs10.x
  stage: ${opt:stage, 'dev'}
  timeout: 15
  tracing:
    apiGateway: true
    lambda: true
  logs:
    restApi:
      level: INFO
      executionLogging: true
      fullExecutionData: true
    frameworkLambda: true
  individually: true
  memorySize: 128
  role: LambdaRole
  environment:
    AWS_XRAY_CONTEXT_MISSING: LOG_ERROR
    NODE_PATH: "./:/opt/node_modules"
    ENV: ${self:provider.stage}
    LAMBDA_ROLLBAR_TOKEN: ${env:LAMBDA_ROLLBAR_TOKEN}
    CODE_VERSION: ${env:CIRCLE_SHA1}
    USER_POOL_ID: { Ref: UserPool }
    USER_POOL_CLIENT_ID: { Ref: UserPoolClientServer }
    STRIPE_SECRET_KEY: ${env:STRIPE_SECRET_KEY}
    DB_USER: ${self:service.app}${opt:stage}user
    DB_PW: 1KdOl7CJ&#Lv1
    DB_NAME: ${self:service.app}${opt:stage}db
    VPC_CIDR: 10

package:
  individually: true

custom:
  serverless-offline:
    port: 3001
  corsConfig: &corsConfig
    origin: "*"
    allowCredentials: true
  authorizerConfig: &authorizerConfig
    type: COGNITO_USER_POOLS
    authorizerId:
      Ref: ApiGatewayAuthorizer

layers:
  shared:
    path: layer
    name: ${self:service.app}-SharedLayer-${self:provider.stage}
    description: "Additional ${self:service.app} nodejs dependencies"
    compatibleRuntimes:
      - ${self:provider.runtime}

functions:
  signup:
    handler: handlers/onboarding/signup.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: signup
          cors: *corsConfig

  signup-resend-code:
    handler: handlers/onboarding/resendCode.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: signup/resend
          cors: *corsConfig

  signup-confirm:
    handler: handlers/onboarding/confirm.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: signup/confirm
          cors: *corsConfig

  user-list:
    handler: handlers/users/list.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: get
          path: users/list
          cors: *corsConfig
          authorizer: *authorizerConfig

  user-create:
    handler: handlers/users/create.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: users/create
          cors: *corsConfig
          authorizer: *authorizerConfig

  customer-list:
    handler: handlers/customers/list.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: get
          path: customers/list
          cors: *corsConfig
          authorizer: *authorizerConfig

  customer-create:
    handler: handlers/customers/create.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: customers/create
          cors: *corsConfig
          authorizer: *authorizerConfig

  customer-update:
    handler: handlers/customers/update.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: customers/{id}/update
          cors: *corsConfig
          authorizer: *authorizerConfig
          request:
            parameters:
              paths:
                id: true

  customer-detail:
    handler: handlers/customers/detail.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: get
          path: customers/{id}/update
          cors: *corsConfig
          authorizer: *authorizerConfig
          request:
            parameters:
              paths:
                id: true

  job-list:
    handler: handlers/jobs/list.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: get
          path: jobs/list
          cors: *corsConfig
          authorizer: *authorizerConfig

  job-list-pending:
    handler: handlers/jobs/list-pending.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: get
          path: jobs/list/pending
          cors: *corsConfig
          authorizer: *authorizerConfig

  job-create:
    handler: handlers/jobs/create.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: jobs/create
          cors: *corsConfig
          authorizer: *authorizerConfig

  job-update:
    handler: handlers/jobs/update.default
    layers:
      - { Ref: SharedLambdaLayer }
    events:
      - http:
          method: post
          path: jobs/{id}/update
          cors: *corsConfig
          authorizer: *authorizerConfig
          request:
            parameters:
              paths:
                id: true

resources:
  Resources:
    UserPool: ${file(./resources/UserPool.yml)}
    UserPoolClient: ${file(./resources/UserPoolClient.yml)}
    UserPoolClientServer: ${file(./resources/UserPoolClientServer.yml)}
    ApiGatewayAuthorizer: ${file(./resources/ApiGatewayAuthorizer.yml)}
    GatewayResponseDefault4XX: ${file(./resources/GatewayResponseDefault4XX.yml)}
    LambdaRole: ${file(./resources/LambdaRole.yml)}
    InternetGateway: ${file(./resources/InternetGateway.yml)}
    VPC: ${file(./resources/VPC.yml)}
    VPCGA: ${file(./resources/VPCGA.yml)}
    SubnetA: ${file(./resources/SubnetA.yml)}
    SubnetB: ${file(./resources/SubnetB.yml)}
    SubnetC: ${file(./resources/SubnetC.yml)}
    SubnetGroup: ${file(./resources/SubnetGroup.yml)}
    SecurityGroup: ${file(./resources/SecurityGroup.yml)}
    RouteTablePublic: ${file(./resources/RouteTablePublic.yml)}
    RoutePublic: ${file(./resources/RoutePublic.yml)}
    RouteTableAssociationSubnetA: ${file(./resources/RouteTableAssociationSubnetA.yml)}
    RouteTableAssociationSubnetB: ${file(./resources/RouteTableAssociationSubnetB.yml)}
    RouteTableAssociationSubnetC: ${file(./resources/RouteTableAssociationSubnetC.yml)}
    PostgreSqlRDSInstance: ${file(./resources/PostgreSqlRDSInstance.yml)}
